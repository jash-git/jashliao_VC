<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0034)http://dozb.bokee.com/5186731.html -->
<HTML><HEAD><TITLE>Using WinInet to call a Web service --C++之dozb的程序人生</TITLE>
<META http-equiv=Content-Type content="text/html; charset=GBK">
<META http-equiv=Pragma content=no-cache>
<META http-equiv=Cache-Control content=no-cache>
<META http-equiv=Expires content=0>
<META 
content="OSWorkflow 探索 Using WinInet to call a Web service dozber  博客 博客中国 博客动力 blog blogdriver blogger 中国" 
name=description>
<META 
content="C++之dozb的程序人生 OSWorkflow 探索 Using WinInet to call a Web service dozber 博客 博客中国 博客动力 blog blogdriver blogger 中国" 
name=keywords><LINK href="Using WinInet to call a Web service.files/diary.css" 
type=text/css rel=stylesheet>
<SCRIPT language=JavaScript 
src="Using WinInet to call a Web service.files/UBB.js"></SCRIPT>

<SCRIPT src="Using WinInet to call a Web service.files/blog.js" 
type=text/javascript></SCRIPT>

<META content="MSHTML 6.00.2900.3243" name=GENERATOR></HEAD>
<BODY>
<DIV 
style="FONT-SIZE: 12px; MARGIN-LEFT: auto; WIDTH: 750px; MARGIN-RIGHT: auto; TEXT-ALIGN: right"><A 
href="http://www.bokee.com/" target=_blank>首页</A> | <A 
href="http://group.bokee.com/" target=_blank>博客群</A> | <A 
href="http://blogs.bokee.com/" target=_blank>公社</A> | <A 
href="http://column.bokee.com/" target=_blank>专栏</A> | <A 
href="http://bbs.bokee.com/" target=_blank>论坛</A> | <A 
href="http://photo.bokee.com/" target=_blank>图片</A> | <A 
href="http://news.bokee.com/" target=_blank>资讯</A> | <A 
href="http://reg.bokee.com/account/web/register.jsp"><FONT 
color=#ff6600>注册</FONT></A> | <A 
href="http://help.bokee.com:8086/help/index.html" target=_blank>帮助</A> | <A 
href="http://lianbo.booso.com/" target=_blank><FONT 
color=#ff6600>博客联播</FONT></A> | <A 
href="http://ping.bokee.com:81/memcm/random.b"><FONT 
color=#ff6600>随机访问</FONT></A> </DIV>
<DIV id=container>
<DIV id=header>
<H1 class=title><A 
href="http://dozb.bokee.com/index.html">C++之dozb的程序人生</A></H1></DIV>
<DIV id=category><A title=上一篇 
href="http://dozb.bokee.com/4996003.html">OSWorkflow 探索 </A>- -| <A 
href="http://dozb.bokee.com/index.html">回首页</A> | <A 
href="http://dozb.bokee.com/catalog_2006.html">2006年索引</A> | - -<A title=下一篇 
href="http://dozb.bokee.com/5377226.html">dozber</A></DIV>
<DIV class=entity>
<H2 class=diaryTitle>Using WinInet to call a Web service 
</H2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 

<P>
<TABLE 
style="BORDER-RIGHT: #7690b1 1px solid; BORDER-TOP: #7690b1 1px solid; BORDER-LEFT: #7690b1 1px solid; BORDER-BOTTOM: #7690b1 1px solid" 
cellSpacing=2 cellPadding=10 width="100%">
  <TBODY>
  <TR>
    <TD class=small_text bgColor=#eeeeee><SPAN class=xmlQue>Using WinInet to 
      call a Web service</SPAN> <BR><SPAN class=small_text>I am working on a 
      MFC/C++ application, and need to call a Web service. I would like to avoid 
      adding any dependency or use any other API (MSXML or SOAP Toolkit), and 
      continue with my application's minimum requirements (which includes 
      Internet Explorer 5.5 or above), and still write the Web service client 
      code. In other words, can you please show me an example of using WinInet 
      to call a Web service? </SPAN></TD></TR>
  <TR>
    <TD class=small_text bgColor=#ffffff><IMG hspace=3 
      src="Using WinInet to call a Web service.files/bluearrow.gif" 
      align=absMiddle border=0><SPAN class=xmlQue>Answer:</SPAN><BR><SPAN 
      class=small_text><A class=LM1 
      href="http://www.perfectxml.com/downloads/WinInetMFCWebSvc.zip">Click 
      here</A> to download a sample console application that uses MFC WinInet 
      classes to call a Web service. <BR><BR>MFC provides wrapper classes around 
      WinInet API. These classes simplify the task of writing HTTP/FTP client 
      applications. Following are the eight steps required to send a HTTP 
      request using MFC WinInet classes: 
      <OL>
        <LI>Create an instance of <SPAN 
        class=code><B>CInternetSession</B></SPAN> class. This begins an HTTP 
        session.<BR><BR>
        <LI>Call <SPAN 
        class=code><B>CInternetSession::GetHttpConnection</B></SPAN> to get an 
        instance of <SPAN class=code><B>CHttpConnection</B></SPAN>. Pass the 
        server and HTTP port to this method, and it establishes a connection to 
        an HTTP server.<BR><BR>
        <LI>Open an HTTP request using <SPAN 
        class=code><B>CHttpConnection::OpenRequest</B></SPAN>. Pass the rest of 
        the URL (except server name), the HTTP method (GET/POST/...) to this 
        method, and it returns a <SPAN class=code><B>CHttpFile</B></SPAN> 
        object. <BR><BR>
        <LI>Optionally, call <SPAN 
        class=code><B>CHttpFile::AddRequestHeaders</B></SPAN> to supply any 
        request headers.<BR><BR>
        <LI>Call <SPAN class=code><B>CHttpFile::SendRequest</B></SPAN> to 
        actually send the request and get the response back.<BR><BR>
        <LI>Use <SPAN class=code><B>CHttpFile::QueryInfoStatusCode</B></SPAN> to 
        find out if the HTTP request succeeded.<BR><BR>
        <LI>On success, use <SPAN class=code><B>pHttpFile-&gt;Read</B></SPAN> to 
        read the response bytes.<BR><BR>
        <LI>Finally, call <SPAN class=code><B>CHttpFile::Close</B></SPAN> and 
        <SPAN class=code><B>CHttpConnection::Close</B></SPAN>. </LI></OL>Here is a 
      Web service client code that uses MFC WinInet classes to call <A class=LM1 
      href="http://www.xmethods.com/ve2/ViewListing.po;jsessionid=E8te_EZgT1646EUo1Bs1ISbs(QhxieSRM)?key=uuid:477CEED8-1EDD-89FA-1070-6C2DBE1685F8" 
      target=_blank>Weather - Temperature</A> Web service (written using Apache 
      SOAP) on XMethods.com. This Web service, given a zip code (US only), 
      returns the current temperature. <BR><PRE style="BACKGROUND-COLOR: #eeeeee"><CODE style="BACKGROUND-COLOR: #eeeeee">...
...
#include &lt;afxinet.h&gt;
...
...

static const TCHAR* g_lpszSOAPRequest =    
_T("&lt;soap:Envelope "
    "xmlns:n='urn:xmethods-Temperature' "
    "xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/' "
    "xmlns:soapenc='http://schemas.xmlsoap.org/soap/encoding/' "
    "xmlns:xs='http://www.w3.org/2001/XMLSchema' "
    "xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'&gt; "
    "&lt;soap:Body soap:encodingStyle='http://schemas.xmlsoap.org/soap/encoding/'&gt; "
    "  &lt;n:getTemp&gt; "
    "     &lt;zipcode xsi:type='xs:string'&gt;98007&lt;/zipcode&gt; "
    "  &lt;/n:getTemp&gt; "
   "&lt;/soap:Body&gt; "
"&lt;/soap:Envelope&gt;");

#define CHUNK_SIZE      2048
   
void CallWebService()
{
   try
   {
      <FONT color=#008000>//   1. Instantiate CInternetSession</FONT>
      CInternetSession httpSession(_T("Sample Web Service Client"), 
                           1,
                           INTERNET_OPEN_TYPE_PRECONFIG,
                           NULL,
                           NULL,
                           INTERNET_FLAG_DONT_CACHE);
      
      <FONT color=#008000>//   2. Get CHttpConnection (Server URL and Port required)</FONT>
      CHttpConnection* pHttpConnection = 
                              httpSession.GetHttpConnection(_T("services.xmethods.net"), 
                                 INTERNET_FLAG_NO_AUTO_REDIRECT,
                                 80, NULL, NULL);

      <FONT color=#008000>//   3. Open HTTP Request (pass method type [get/post/..] and URL path (except server name))</FONT>
      CHttpFile* pHttpFile             = 
                              pHttpConnection-&gt;OpenRequest
                              (_T("POST"), 
                                 _T("soap/servlet/rpcrouter"), 
                                 NULL, 1, NULL, NULL, 
                                 INTERNET_FLAG_KEEP_CONNECTION |
                                 INTERNET_FLAG_EXISTING_CONNECT |
                                 INTERNET_FLAG_DONT_CACHE |
                                 INTERNET_FLAG_RELOAD);

      <FONT color=#008000>//   4. Add HTTP Request Headers</FONT>
      CString strSOAPReq(g_lpszSOAPRequest);
      DWORD dwRewLen = strSOAPReq.GetLength();
      CString strHeaders;
      strHeaders.Format(_T("Content-Type: text/xml; charset=utf-8\nContent-Length:%d"), 
         dwRewLen);
      pHttpFile-&gt;AddRequestHeaders(strHeaders);

      
      <FONT color=#008000>//   5. Send the request</FONT>
      pHttpFile-&gt;SendRequest(NULL, 0, (LPVOID)(LPCTSTR)strSOAPReq, dwRewLen);

      <FONT color=#008000>//   6. Check the return HTTP Status Code</FONT>
      DWORD dwStatucCode = HTTP_STATUS_OK;

      pHttpFile-&gt;QueryInfoStatusCode(dwStatucCode);

      if(dwStatucCode == HTTP_STATUS_OK)
      {
         CString strResponse;
         TCHAR szBuf[CHUNK_SIZE] = {0};
         UINT nBytesRead;

         <FONT color=#008000>//   7. Read the response text</FONT>
         do
         {
            nBytesRead = pHttpFile-&gt;Read((void*) szBuf, CHUNK_SIZE);
            strResponse += szBuf;
            if(nBytesRead &lt; CHUNK_SIZE)
               break;
         }while(nBytesRead == CHUNK_SIZE);

         AfxMessageBox(strResponse);
         <FONT color=#008000>//TODO: Process the response</FONT>
      }
      else
      {
         <FONT color=#008000>//TODO: Error handling</FONT>
      }

      <FONT color=#008000>//   8. Close the stream/connection</FONT>
      if(pHttpFile)
      {
         pHttpFile-&gt;Close();
         delete pHttpFile;
         pHttpFile = NULL;
      }

      if(pHttpConnection)
      {
         pHttpConnection-&gt;Close();
         delete pHttpConnection;
         pHttpConnection = NULL;
      }

   }
   catch(CInternetException* exp)
   {
      TCHAR lpszErrorMsg[MAX_PATH+2];
      exp-&gt;GetErrorMessage(lpszErrorMsg, MAX_PATH);
      AfxMessageBox(lpszErrorMsg);
   }
}
</CODE></PRE></SPAN></TD></TR></TBODY></TABLE></P>
<P class=diaryFoot>【作者: <A 
onclick="window.open('http://publishblog.blogchina.com/blog/postMessage.b?receiver=490964','发送短消息','width=520, height=455')" 
href="javascript:void(0);">dozb</A>】【访问统计:
<SCRIPT language=JavaScript 
src="Using WinInet to call a Web service.files/PageServlet.htm"></SCRIPT>
】【2006年06月8日 星期四 18:50】【<A 
href="http://reg.bokee.com/account/web/register.jsp"><FONT 
color=#ff6600>注册</FONT></A>】【<A href="javascript:window.print();">打印</A>】 
</TD></P></DIV>
<DIV class=col-body>
<SCRIPT language=JavaScript 
src="Using WinInet to call a Web service.files/request_ads.js"></SCRIPT>

<SCRIPT src="Using WinInet to call a Web service.files/show_ads.js"></SCRIPT>
</DIV>
<DIV class=operation><A name=search>
<H3>搜索</H3></A>
<SCRIPT type=text/javascript>
<!--
 function submitFormWithChannel(channelname) {
  document.gform.channel.value=channelname;
  document.gform.submit();
  return;
 }
//-->
<!-- End of Script for Clickable Google Logo -->

</SCRIPT>

<FORM id=gform name=gform action=http://www.google.cn/search method=get 
target=_top>
<TABLE width=700 bgColor=#ffffff border=0>
  <TBODY>
  <TR>
    <TD vAlign=center noWrap align=middle height=32><!-- Clickable Google Logo --><A 
      href="javascript:submitFormWithChannel('logo')"><IMG height=23 alt=Google 
      src="Using WinInet to call a Web service.files/logo_Google.gif" width=75 
      align=middle border=0> </A><!-- END of Clickable Google Logo --><!-- Google Web Union Search Box --><INPUT 
      maxLength=255 size=40 name=q></INPUT> <INPUT onclick="javascript:document.getElementById('channel').value='sitesearch';document.getElementById('sitesearch').value='bokee.com';document.getElementById('gform').submit();" type=button value=站内搜索 name=sb> 
      </INPUT><INPUT onclick="javascript:document.getElementById('channel').value='internetsearch';document.getElementById('sitesearch').value='';document.getElementById('gform').submit();" type=button value=搜索 name=sa> 
      </INPUT><INPUT id=sitesearch type=hidden name=sitesearch> <INPUT 
      type=hidden value=aff-bokee name=client> </INPUT><INPUT type=hidden 
      value=gbk name=ie> </INPUT><INPUT type=hidden value=gbk name=oe> 
      </INPUT><INPUT type=hidden value=zh-CN name=hl> </INPUT><INPUT id=channel 
      type=hidden value=search name=channel> </INPUT></TD>
    <TD 
noWrap><!-- End of Google Web Union Search Box --></TD></TR></TBODY></TABLE></FORM></DIV>
<DIV class=operation><A name=trackback>
<H3>Trackback</H3></A>
<P class=trackback>你可以使用这个链接引用该篇文章 
http://publishblog.blogchina.com/blog/tb.b?diaryID=5186731 </P></DIV>
<DIV class=operation><A name=comment>
<H3>回复</H3></A>
<TABLE cellSpacing=0 cellPadding=0 width=700 border=0>
  <TBODY>
  <TR align=left>
    <TD align=middle rowSpan=2><IMG 
      src="Using WinInet to call a Web service.files/unknowman.gif"> </TD>
    <TD colSpan=4>
      <H4><A name=comment$(remark.remarkID)>- 评论人：sgds</A> 
      <SPAN>&nbsp;&nbsp;2007-09-04 14:45:18&nbsp;<A> <IMG 
      src="Using WinInet to call a Web service.files/linkblog.jpg" border=0> 
      </A>　 </SPAN></H4></TD></TR>
  <TR align=left>
    <TD vAlign=top colSpan=4>
      <P class=comment>强烈的顶顶顶!!! <BR><BR>15G空间=5个网站=500元/年 可免费试用 
      <BR>www.abcnic.com QQ：1012727 <BR>5GB 独立WEB空间、5GB 企业邮箱空间、5GB MSSQL数据库 
      <BR>IIS连接数据 500 个、500GB/月流量、共享日志文件空间 <BR><BR>数据库功能 <BR>支持5GB 
      MSSQL数据库空间，5个用户数据库、Access <BR><BR>主机功能支持 <BR>采用安全稳定的Win2003 .net2.0 架构 
      <BR>支持ASP、PHP、ASP.NET、PERL等脚本、支持自定义CGI 
      <BR>全面支持.net2.0版本，独立的Application应用池， <BR>支持SSI（Shtml），支持FrontPage扩展 
      <BR>可免费自行绑定5个域名、500个解析、500个子域名 <BR><BR>企业邮箱功能 <BR>赠送5GB 
      超大企业邮箱，500个Email企业邮箱用户 <BR>自动回复、自动转发、POP3、SMTP收发信、SMTP发信认证 
      <BR>邮件过滤、邮件拒收、邮件夹管理、邮件域管理、定制邮件数<BR></P></TD></TR></TBODY></TABLE></DIV>
<DIV class=operation>
<TABLE class=comment cellSpacing=0 cellPadding=0 width=700 border=0>
  <FORM id=replyForm method=post><INPUT type=hidden value=491475 name=blogID> 
  <INPUT type=hidden value=5186731 name=diaryID> <INPUT type=hidden value=dozb 
  name=blogDomino>
  <SCRIPT>
if(getCookie('userID') == null){        
document.write('<tr><td width="70">发布人：</td>');
document.write('<td width="150"> <input name="remark.authorNameFUI" type="text" size="20" class="inputStyle" maxlength="20"></td>');
document.write('<td width="70">邮箱：</td>');
document.write('<td width="435"> <input name="remark.authorEmail" type="text" size="20" class="inputStyle" maxlength="40"></td>');
document.write('</tr><tr><td>主　页：</td>');
document.write('<td colspan="3"> <input name="remark.authorURL" type="text" class="inputStyle" value="HTTP://" size="63" maxlength="100"></td></tr>');
}else{
document.write('<input type="hidden" name="remark.authorNameFUI" value="Blogchina网友">');
}
</SCRIPT>
   
  <TBODY>
  <TR>
    <TD width=70>验证码：</TD>
    <TD><INPUT class=inputStyle maxLength=4 name=validateCode></TD>
    <TD>&nbsp;&nbsp;<IMG 
      src="Using WinInet to call a Web service.files/getValidateImg.gif" 
      border=0></TD></TR>
  <TR align=left>
    <TD colSpan=4>评论内容：<BR><TEXTAREA class=textStyle id=remark name=remark.remarkFUI rows=8 cols=60>          </TEXTAREA> 
    </TD></TR>
  <TR align=left>
    <TD colSpan=4>　　　　　　 　　　　　　 <INPUT onclick=reply() type=button value=提交> 　 
<INPUT type=reset value=重置> </TD></TR></FORM></TBODY></TABLE></DIV></DIV>
<SCRIPT src="Using WinInet to call a Web service.files/extend3.js" 
type=text/javascript></SCRIPT>

<DIV id=footer><A href="http://blog.bokee.com/">2003-2004 BOKEE.COM All rights 
reserved</A><BR><A href="http://www.blogdriver.com/">Powered by BlogDriver 
2.1</A> </DIV>
<SCRIPT type=text/javascript>

<!--

Empty_show = "empty.gif";

TelSense_ad_output = "ZoneID";

TelSense_ad_format = "";

Product_zoneID = "167";

Web_userID = "193";

//-->

</SCRIPT>
<!-- <script type="text/javascript" src="http://luliangtest.bokee.com/show.php"> --></SCRIPT></BODY></HTML>
