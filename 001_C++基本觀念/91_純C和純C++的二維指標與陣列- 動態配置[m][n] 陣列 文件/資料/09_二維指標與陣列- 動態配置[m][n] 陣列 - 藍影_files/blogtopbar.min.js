window.requestTimeout=function(t,e){"use strict";function n(){var o=(new Date).getTime(),r=o-a;r>=e?t.call():i.value=window.requestAnimFrame(n)}if(!(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame&&window.mozCancelRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame))return window.setTimeout(t,e);var a=(new Date).getTime(),i={};return i.value=window.requestAnimFrame(n),i},window.clearRequestTimeout=function(t){window.cancelAnimationFrame?window.cancelAnimationFrame(t.value):window.webkitCancelAnimationFrame?window.webkitCancelAnimationFrame(t.value):window.webkitCancelRequestAnimationFrame?window.webkitCancelRequestAnimationFrame(t.value):window.mozCancelRequestAnimationFrame?window.mozCancelRequestAnimationFrame(t.value):window.oCancelRequestAnimationFrame?window.oCancelRequestAnimationFrame(t.value):window.msCancelRequestAnimationFrame?window.msCancelRequestAnimationFrame(t.value):clearTimeout(t)},window.requestAnimFrame=function(){"use strict";return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),function(t){"use strict";var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};t.fn.replaceTpl=function(t,n){var a=/\#\{\$(.+?)\}/g,i=e;return t.replace(a,function(t){return String(n[t.replace(a,"$1")]).replace(/[&<>"'\/]/g,function(t){return i[t]})})}}(jQuery),function(t){"use strict";t.support.cssProperty=function(t){for(var e=",Webkit,Moz,O,ms,Khtml".split(","),n=e.length,a=!1,i=0;n>i&&(i&&(t=t.charAt(0).toUpperCase()+t.substr(1)),!(a=e[i]+t in document.body.style));i++);return a}}(jQuery),function(t,e,n){"use strict";var a=!!t.browser.msie&&9>=1*t.browser.version;t.fn.Search=function(i){var o=this,r=i.jqSearch,s=i.jqSearchInput,c=i.jqSearchBtn,u=i.jqSearchReset,l=i.jqSearchSuggestion,d={show:i.suggestionShowClass,item:i.suggestionItemClass,selected:i.suggestionSelectedClass};this.searchSuggestion=function(){var n={kwdCached:{},kwdTpl:{item:i.suggestionItemTpl,mark:"<mark>$1</mark>"}},a=l;return n.getKwd=function(e){if(e=t.trim(String(e)),!e.length)return void n.hideKwd();var i=n.setKwdCount();n.kwdCached[e]?n.showKwd(n.kwdCached[e],e):!function(i){t.ajax({url:"//emma.pixnet.cc/mainpage/keywords/search.json?sort=count&limit=10&q="+e,dataType:"jsonp"}).done(function(t){var o=t.keywords;t.error||(o.length?(n.kwdCached[e]=o,i===a.data("kwd-counter")&&n.showKwd(o,e)):n.hideKwd())})}(i)},n.setKwdCount=function(){var t,e=a.data("kwd-counter")||0;return a.data("kwd-counter",e+1),t=a.data("kwd-counter")},n.hideKwd=function(t){t&&a.empty(),a.removeClass(d.show)},n.showKwd=function(e,i){for(var o,r=0,s=e.length,c="",u=t("<ul />"),l=new RegExp("("+i.replace(/(\W)/g,"\\$1")+")","gi");s>r;r+=1)o=u.html(t.fn.replaceTpl(n.kwdTpl.item,{keyword:e[r]})).children("li"),o.html(o.html().replace(l,n.kwdTpl.mark)),c+=u.html();a.html(c).addClass(d.show),c=u=o=null},n.fillKwd=function(t){var e=a.find("."+d.selected);e.length&&(t=t||e.text(),s.val(t))},n.selectKwd=function(t){if(27===t)return n.hideKwd(),void s.val(e.unescape(s.data("kwd")));a.addClass(d.show);var i=a.find("li"),o=i.length,r=i.filter("."+d.selected).index(),c=38===t?-1:1,u=(r+c)%o;i.length||n.getKwd(s.val()),i.removeClass(d.selected).eq(u).addClass(d.selected),n.fillKwd()},n}(),this.checkSearchVal=function(){""===s.val()?u.hide():u.show()},this.validateForm=function(){return 0!==s[0].value.length},this.submitCount=function(t,a){var i,o=new Image(1,1),r=function(){e.clearRequestTimeout(i),n.location.href=a};o.src=t,o.onload=r,o.onerror=r,i=e.requestTimeout(r,500)},this.submit=function(){var t,e=c.find("button").eq(0),n=e.val(),a=e.data("counterlink"),i=s[0].maxLength;i<s[0].value.length&&s.val(s.val().slice(0,i)),t=r.attr("action")+"?"+r.serialize()+"&search="+n,t&&o.submitCount(a,t)},this.init=function(){if(c.on("click.switch","button",function(){var e=t(this);0!==e.index()&&c.prepend(e)}),i.autoFocusBtn){var f=location.pathname.split(/^\//)[1],m=c.find("button").filter('[value="'+f+'"]');e.setTimeout(function(){m.trigger("click.switch")},0)}r.on("submit.check",function(t){t.preventDefault(),o.validateForm()&&o.submit()}),s.on({"input.reset change.reset":o.checkSearchVal,"input.kwd change.kwd focus.kwd":function(){o.searchSuggestion.getKwd(s.val())}}),i.suggestionKeyboard&&s.on({"keyup.kwdCtrl input.kwdCtrl":function(t){var n=t.keyCode,i=s.val();switch(n){case 27:case 38:case 40:t.preventDefault(),o.searchSuggestion.selectKwd(n);break;default:a&&o.searchSuggestion.getKwd(i),s.data("kwd",e.escape(i))}}}),u.on("click.reset",function(t){t.preventDefault(),s[0].value="",o.checkSearchVal(),o.searchSuggestion.hideKwd()}),l.on("mouseenter",function(){s.blur()}).on("mouseenter.selectKwd","."+d.item,function(){t(this).siblings().removeClass(d.selected).end().addClass(d.selected)}).on("mouseleave.selectKwd","."+d.item,function(){t(this).removeClass(d.selected)}).on("click.suggestion","."+d.item,function(){o.searchSuggestion.fillKwd(),o.searchSuggestion.hideKwd(),r.submit()}),t(n).on("click.suggestion",function(e){0===t(e.target).parents().filter(r).length&&o.searchSuggestion.hideKwd()})}}}(jQuery,window,document),function(t,e,n,a,i){"use strict";t(function(){var o,r,s,c,u,l=!!t.browser.msie&&9>=1*t.browser.version,d="is-active";o=function(t){return n.getElementById(t)},u={},u.win=t(e),u.doc=t(n),u.topbar=function(){var e=t(o("topbar")),n=e.find(".topbar__search"),a=e.find(".topbar__nav");return{topbar:e,search:n,announce:e.find(".topbar__announce"),nav:a,notification:a.find(".topbar__notification"),user:a.find(".topbar__user"),lang:a.find(".topbar__lang")}}(),s=function(t){var n=t.jqAnnounce,a=n.find("a"),i=t.hideClass,o={index:0,total:a.length,duration:t.duration};this.carousel=function(){!function t(){e.setTimeout(function(){var e=o.index;o.index=(e+1)%o.total,a.eq(e).add(a.eq(o.index)).toggleClass(i),t()},o.duration)}()},this.init=function(){this.carousel()}},r=function(){var n=this,a=u.topbar.notification,o=a.find(".topbar__notification__counter"),r=a.find(".topbar__dropdown-lists"),s=a.find(".topbar__flip"),c=a.find(".topbar__notification__msglists"),l=parseFloat(c.css("min-height"),10),f=parseFloat(c.css("max-height"),10),m=150+f,h=6e4,w=60*h,g=24*w;this.transTime=function(t){var e=new Date(t);return{Y:e.getYear(),M:e.getMonth()+1,D:e.getDate(),h:e.getHours(),m:e.getMinutes(),s:e.getSeconds()}},this.formatTime=function(t,e){var a,i,o,r=t-e,s=n.transTime,c=s(e);switch(r/g|0){case 0:o=r/w|0,i=(r/h|0)-60*o,a=1>o?i?i+"分鐘前":"剛剛":o+"小時前";break;case 1:a="昨天"+c.h+":"+c.m;break;default:a=c.M+"月"+c.D+"日"}return a},this.formatMsgDate=function(e){for(var a,i,o,r=t("<ul />"),s=r.html(e).find(".topbar__notification__msglist__time"),c=new Date,u=s.length-1;u>=0;u--)a=new Date(1e3*t(s[u]).text()),i=n.formatTime(c,a),o=a.toLocaleString(),t(s[u]).html(i).attr({title:o}),a=i=null;return e=r.html()},this.ajaxCounter=function(t){if(t)return t===a.data("ajax-counter");var e=a.data("ajax-counter")||0,n=e+1;return a.data("ajax-counter",n),n},this.getData=function(){if(!a.hasClass("ajax-loading")&&!r.hasClass(d)){if(a[0].className=a.data("className"),a.addClass("ajax-loading"),"0"===o.attr("data-counter")&&a.data("latestNotification"))return c.html(n.formatMsgDate(a.data("latestNotification").html)),void setTimeout(function(){a.removeClass("ajax-loading")},0);var e=n.ajaxCounter();t.ajax({url:"/api/notifyentries",dataType:"json"}).done(function(t){t.error?a.addClass("ajax-error"):(a.addClass("ajax-success").data("latestNotification",t),n.ajaxCounter(e)&&t.latestTime!==a.data("latestTime")&&(c.html(n.formatMsgDate(t.html)),a.addClass("ajax-done"),n.latestTime(t.latestTime)),n.counterNum(0))}).fail(function(){a.addClass("ajax-error")}).always(function(){setTimeout(function(){a.removeClass("ajax-loading")},0)})}},this.resize=function(){var t=u.win.height();m>t&&t>l&&c.css("max-height",t-150)},this.latestTime=function(t){return t?void a.data("latestTime",t):a.data("latestTime")},this.counterNum=function(t){var e,n,a="no-notification";return t===i?o.attr("data-counter"):(t=Number(t),e=o.hasClass(a),n=0===t,n||e?n!==e&&(o.attr("data-counter",t),o.toggleClass(a)):o.attr("data-counter",t),void 0)},this.toggleShowHide=function(){o.on("click",function(t){t.preventDefault(),n.getData(),r.toggleClass(d),n.resetFlip()}),u.doc.on("click",function(e){var n=e.target,i=t(n).parents().filter(a).length;i||r.removeClass(d)})},this.resetFlip=function(){s.removeClass("is-flipping")},this.toggleFlip=function(){s.toggleClass("is-flipping")},this.checkUnreadNotiCount=function(){!function i(){e.setTimeout(function(){var o=a.data("latestTime"),r=n.counterNum();t.ajax({url:"/api/getunreadnotifyinfo",type:"GET",dataType:"json",data:{latestTime:o}}).done(function(t){var e=t.unreadNotifyCount;e&&e!==r&&n.counterNum(e)}).fail(function(){e.console&&e.console.log("ajax error: /api/getunreadnotifyinfo")}).always(function(){i()})},6e4)}()},this.init=function(){a.data("className",a[0].className),u.win.on("resize.notification",n.resize),n.toggleShowHide(),a.find(".topbar__notification__list--header__title").on("click",n.toggleFlip),a.find(".topbar__flip--back").on("click",function(t){t.preventDefault(),n.toggleFlip()}),n.checkUnreadNotiCount(),e.setTimeout(function(){u.win.trigger("resize.notification")},0)}},c=function(){var e,a=u.topbar.lang.find(".topbar__lang__lists"),i="/blog/setlocale",o=this;this.sendLang=function(){t.post(i,{locale:e},function(t){t.error||n.location.reload()})},this.init=function(){a.on("click","a",function(){var n=t(this);e=n.data("lang"),o.sendLang()})}},function(){u.topbar.topbar.addClass(function(){for(var e=[t.support.cssProperty("animation"),t.support.cssProperty("borderRadius"),t.support.cssProperty("boxShadow"),!l],n=["cssanimations","borderradius","boxshadow","cssgradients"],a=e.length-1;a>=0;a--)e[a]||(n[a]="no-"+n[a]);return n.join(" ")}),u.topbar.user.add(u.topbar.lang).find(".topbar__dropdown-btn").on("click",function(t){t.preventDefault()}),a.f.topbar=a.f.topbar||{option:{search:!0,announce:!0,notification:!0,switchlang:!0}};var e=function(){var t=u.topbar.search;return{jqSearch:t,jqSearchInput:t.find(".topbar__search__input"),jqSearchBtn:t.find(".topbar__search__btns"),jqSearchReset:t.find(".topbar__search__reset"),jqSearchSuggestion:t.find(".topbar__search__suggestion"),suggestionItemTpl:'<li class="topbar__search__suggestion__item">#{$keyword}</li>',suggestionItemClass:"topbar__search__suggestion__item",suggestionShowClass:"topbar__search__suggestion--show",suggestionSelectedClass:"topbar__search__suggestion__item--selected",suggestion:!0,suggestionKeyboard:!0,autoFocusBtn:!1}}(),n={jqAnnounce:u.topbar.announce,hideClass:"topbar__announce__item--hide",duration:6e3};a.f.topbar.search=new t.fn.Search(e),a.f.topbar.announce=new s(n),u.topbar.notification.length&&(a.f.topbar.notification=new r),a.f.topbar.switchlang=new c;for(var i in a.f.topbar)a.f.topbar.hasOwnProperty(i)&&"option"!==i&&a.f.topbar.option[i]&&a.f.topbar[i].init()}()})}(jQuery,window,document,pix);